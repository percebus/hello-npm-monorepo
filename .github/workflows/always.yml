name: "[C]ontinuous [I]ntegration"
on:
  push:
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab

env:
  REPOSITORY_NAME: ${{ github.event.repository.name }}

  DOCKER_BUILDKIT: 1
  DOCKER_TAG_VERSION: latest

# SEE: percebus/github-actions-npm/.github/workflows/npm_test.yml@main
# "Invalid workflow file: .github/workflows/always.yml#L70
# The workflow is requesting 'actions: read, checks: write, pull-requests: write',
# but is only allowed 'actions: none, checks: none, pull-requests: none'.""
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  npm_test_projects:
    strategy:
      max-parallel: 6
      fail-fast: false
      matrix:
        project:
          - express-app
          - rest-app
    name: npm test ${{ matrix.project }}

    # FIXME
    # uses: percebus/github-actions-npm/.github/workflows/npm_test.yml@main
    # with:
    #   working-directory: ./node/${{ matrix.project }}
    #   # Not all projects have `jest-junit`
    #   reporter: none
    uses: percebus/github-actions-npm/.github/workflows/npm_run_script.yml@main
    with:
      script: test
      working-directory: ./node/${{ matrix.project }}

  yarn_test_projects:
    strategy:
      max-parallel: 6
      fail-fast: false
      matrix:
        project:
          - package-c

    uses: percebus/github-actions-yarn/.github/workflows/yarn_run_script.yml@main
    with:
      working-directory: ./node/${{ matrix.project }}
      script: test

  npm_test:
    needs:
      - npm_test_projects
      - yarn_test_projects
    uses: percebus/github-actions-npm/.github/workflows/npm_test.yml@main
    with:
      reporter: jest-junit
      files_pattern: ./node/*/junit.xml

  yarn_test:
    name: yarn test
    needs:
      - npm_test_projects
      - yarn_test_projects
    uses: percebus/github-actions-yarn/.github/workflows/yarn_run_script.yml@main
    with:
      script: test

  docker_compose:
    name: docker compose
    needs: npm_test
    runs-on: ubuntu-latest
    steps:
      - uses: percebus/github-actions-common/.github/actions/checkout@main

      - name: docker compose build
        run: docker compose build

  docker_build_matrix:
    name: docker build --target
    if: github.ref == 'refs/heads/main'
    needs: docker_compose
    continue-on-error: true
    strategy:
      max-parallel: 10
      matrix:
        DOCKER_TARGET:
          - root
          #
          # These are tested by docker compose
          - express-app
          - rest-app
          # TODO add each package

    runs-on: ubuntu-latest
    steps:
      - uses: percebus/github-actions-common/.github/actions/checkout@main

      - name: "docker build: ${{ matrix.DOCKER_TARGET }}"
        run: |
          docker build . \
            --target ${{ matrix.DOCKER_TARGET }} \
            --tag ${{ env.REPOSITORY_NAME }}.${{ matrix.DOCKER_TARGET }}:${{ env.DOCKER_TAG_VERSION }}
